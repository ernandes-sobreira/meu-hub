<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meu Mundo ‚Äî Hub de Apps do Ernandes</title>
  <meta name="theme-color" content="#0b5cff"/>

  <style>
    :root{
      --bg: #0b1220;
      --bg2:#0f1a33;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --txt: #eaf0ff;
      --muted:#b8c3e6;
      --shadow: 0 18px 60px rgba(0,0,0,.45);

      --brand:#6ea8ff;
      --brand2:#b58cff;

      --ok:#2fe59d;
      --warn:#ffd66e;
      --bad:#ff6e7a;

      --radius: 18px;
      --gap: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--txt);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(110,168,255,.35), transparent 60%),
        radial-gradient(900px 540px at 90% 10%, rgba(181,140,255,.25), transparent 55%),
        radial-gradient(1000px 650px at 40% 120%, rgba(47,229,157,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }

    a{color:inherit; text-decoration:none}
    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 28px 18px 70px;
    }

    header{
      display:flex;
      gap:18px;
      align-items: stretch;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .hero{
      flex: 1 1 640px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      position: relative;
      overflow:hidden;
    }

    .hero::before{
      content:"";
      position:absolute; inset:-80px -60px auto auto;
      width:220px; height:220px;
      background: radial-gradient(circle at 30% 30%, rgba(110,168,255,.45), transparent 60%);
      filter: blur(2px);
      border-radius: 999px;
    }

    .row{
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
    }

    .avatar{
      width:86px; height:86px;
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      position:relative;
      flex: 0 0 auto;
      cursor:pointer;
    }
    .avatar img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
    }
    .avatar .placeholder{
      font-weight:800;
      letter-spacing:.5px;
      color: rgba(234,240,255,.85);
      font-size: 22px;
      user-select:none;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 280px;
    }
    .title h1{
      margin:0;
      font-size: 22px;
      line-height: 1.15;
    }
    .title p{
      margin:0;
      color: var(--muted);
      line-height:1.45;
      font-size: 13.5px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
    }
    .chip{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      color: rgba(234,240,255,.92);
      backdrop-filter: blur(10px);
    }

    .panel{
      flex: 0 0 360px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .panel h2{
      margin:0 0 10px;
      font-size: 14px;
      letter-spacing: .2px;
      color: rgba(234,240,255,.92);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      text-align:center;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: scale(.99); }

    .btn.primary{
      border-color: rgba(110,168,255,.45);
      background: linear-gradient(180deg, rgba(110,168,255,.22), rgba(110,168,255,.08));
    }
    .btn.good{
      border-color: rgba(47,229,157,.45);
      background: linear-gradient(180deg, rgba(47,229,157,.20), rgba(47,229,157,.07));
    }
    .btn.warn{
      border-color: rgba(255,214,110,.45);
      background: linear-gradient(180deg, rgba(255,214,110,.20), rgba(255,214,110,.07));
    }
    .btn.bad{
      border-color: rgba(255,110,122,.50);
      background: linear-gradient(180deg, rgba(255,110,122,.18), rgba(255,110,122,.06));
    }

    .searchRow{
      margin-top: 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
    }

    .search{
      flex:1 1 420px;
      display:flex;
      align-items:center;
      gap:10px;
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
    }
    .search input{
      width:100%;
      background: transparent;
      border:0;
      outline:none;
      color: var(--txt);
      font-size: 14px;
    }
    .search .hint{
      color: rgba(184,195,230,.85);
      font-size: 12px;
      white-space: nowrap;
      user-select:none;
    }

    main{
      margin-top: 18px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
    }

    .sidebar{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 14px;
      height: fit-content;
    }

    .sidebar h3{
      margin: 0 0 10px;
      font-size: 13px;
      color: rgba(234,240,255,.92);
      letter-spacing:.2px;
    }
    .cats{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .catBtn{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition: background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .catBtn:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }
    .catBtn.active{
      background: linear-gradient(180deg, rgba(181,140,255,.20), rgba(181,140,255,.07));
      border-color: rgba(181,140,255,.45);
    }
    .badge{
      font-size: 12px;
      color: rgba(234,240,255,.92);
      border: 1px solid rgba(255,255,255,.14);
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
    }

    .content{
      min-height: 400px;
    }

    .sectionHead{
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .sectionHead h2{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
      color: rgba(234,240,255,.95);
    }
    .sectionHead p{
      margin:0;
      color: rgba(184,195,230,.95);
      font-size: 12.5px;
      max-width: 660px;
      line-height:1.45;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 980px){
      .cards{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 560px){
      .cards{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      position: relative;
      overflow:hidden;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .card:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.18);
    }

    .cardTop{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content: space-between;
    }

    .pill{
      font-size: 11px;
      border-radius: 999px;
      padding: 5px 8px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,255,.92);
      width: fit-content;
    }

    .card h4{
      margin: 2px 0 0;
      font-size: 14px;
      line-height:1.25;
    }
    .card p{
      margin:0;
      color: rgba(184,195,230,.95);
      font-size: 12.5px;
      line-height:1.45;
      min-height: 34px;
    }

    .cardActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 2px;
    }

    .mini{
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 12.5px;
      font-weight: 700;
    }

    .empty{
      border: 1px dashed rgba(255,255,255,.25);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding: 16px;
      color: rgba(234,240,255,.85);
      line-height: 1.55;
    }

    /* Modal */
    .modalBackdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(720px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(15,26,51,.92), rgba(11,18,32,.92));
      box-shadow: 0 30px 90px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHeader h3{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .close{
      width:38px; height:38px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      cursor:pointer;
      font-size: 18px;
      font-weight: 800;
    }
    .modalBody{
      padding: 14px 16px 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px){
      .modalBody{ grid-template-columns: 1fr; }
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size: 12px;
      color: rgba(184,195,230,.95);
    }
    input, textarea, select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      padding: 10px 12px;
      color: var(--txt);
      outline:none;
      font-size: 14px;
    }
    textarea{ min-height: 92px; resize: vertical; }
    .modalFooter{
      padding: 12px 16px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      border-top: 1px solid rgba(255,255,255,.10);
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(15,26,51,.95);
      border: 1px solid rgba(255,255,255,.16);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      display:none;
      z-index: 60;
      font-size: 13px;
    }

    .smallNote{
      margin-top: 10px;
      color: rgba(184,195,230,.9);
      font-size: 12px;
      line-height:1.5;
    }

    .foot{
      margin-top: 18px;
      color: rgba(184,195,230,.8);
      font-size: 12px;
      line-height:1.55;
      opacity:.95;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <section class="hero">
        <div class="row">
          <div class="avatar" id="avatarBox" title="Clique para definir sua foto">
            <div class="placeholder" id="avatarPH">ES</div>
            <img id="avatarImg" alt="Foto de perfil" style="display:none;">
          </div>

          <div class="title">
            <h1 id="nameEl">Ernandes Sobreira</h1>
            <p id="bioEl">
              Cacerense ‚Ä¢ Bi√≥logo ‚Ä¢ Pai do Davi e da Sara ‚Ä¢ Marido da B√°rbara<br/>
              Mestre em Ecologia e Conserva√ß√£o da Biodiversidade ‚Ä¢ Doutor em Ci√™ncia (Radboud University)<br/>
              Professor visitante da Universidade do Estado de Mato Grosso (UNEMAT)
            </p>
            <div class="chips" id="chips"></div>
          </div>
        </div>

        <div class="foot">
          <strong>O que √© ‚Äúmulti-dados‚Äù aqui?</strong><br/>
          √â um jeito pr√°tico de dizer: <em>um ecossistema de ferramentas diferentes</em> (clima, carbono, sa√∫de, mapas, jogos, educa√ß√£o, pain√©is e apps)
          reunidas num √∫nico lugar. Voc√™ n√£o precisa lembrar onde hospedou cada coisa: entra aqui e acha tudo por categoria.
        </div>
      </section>

      <aside class="panel">
        <h2>Atalhos</h2>
        <div class="grid2">
          <button class="btn primary" id="btnAdd">+ Adicionar link</button>
          <button class="btn" id="btnEditProfile">Editar perfil</button>
          <button class="btn good" id="btnExport">Exportar (JSON)</button>
          <button class="btn warn" id="btnImport">Importar (JSON)</button>
          <button class="btn" id="btnOpenAll">Abrir categoria</button>
          <button class="btn bad" id="btnReset">Resetar</button>
        </div>

        <div class="smallNote">
          ‚Ä¢ Tudo √© salvo no seu navegador (localStorage).<br/>
          ‚Ä¢ Use Exportar/Importar pra levar seus links pra outro PC/celular.
        </div>
      </aside>
    </header>

    <div class="searchRow">
      <div class="search" title="Pesquisar por nome, descri√ß√£o ou URL">
        <span class="hint">üîé</span>
        <input id="search" placeholder="Pesquisar‚Ä¶ (ex.: carbono, pantanal, dengue, quiz, mapbiomas)" />
        <span class="hint" id="countHint">0 links</span>
      </div>

      <div class="row" style="justify-content:flex-end; gap:10px;">
        <button class="btn" id="btnNewCategory">+ Categoria</button>
        <button class="btn" id="btnSort">Ordenar A‚ÜíZ</button>
      </div>
    </div>

    <main>
      <aside class="sidebar">
        <h3>Categorias</h3>
        <div class="cats" id="cats"></div>
        <div class="smallNote">
          Dica: crie categorias do seu jeito (ex.: Clima, Hidrologia, Mapas, Extens√£o, Ensino, Bibliometria).
        </div>
      </aside>

      <section class="content">
        <div class="sectionHead">
          <div>
            <h2 id="sectionTitle">Tudo</h2>
            <p id="sectionDesc">Seus apps e plataformas organizados em bot√µes. Clique em ‚ÄúVisitar‚Äù para abrir.</p>
          </div>
        </div>

        <div id="cards" class="cards"></div>

        <div id="empty" class="empty" style="display:none;">
          <strong>Nenhum link por aqui ainda.</strong><br/>
          Clique em <b>‚Äú+ Adicionar link‚Äù</b> e comece a montar seu hub.
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Link -->
  <div class="modalBackdrop" id="modalLink">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3 id="modalLinkTitle">Adicionar link</h3>
        <button class="close" id="closeLink" aria-label="Fechar">√ó</button>
      </div>

      <div class="modalBody">
        <label>
          Nome do app / plataforma
          <input id="fTitle" placeholder="Ex.: Painel Dengue ‚Ä¢ Climogramas-BR ‚Ä¢ Jogo Carbono" />
        </label>

        <label>
          Categoria
          <select id="fCat"></select>
        </label>

        <label style="grid-column:1/-1;">
          URL (link)
          <input id="fUrl" placeholder="https://..." />
        </label>

        <label style="grid-column:1/-1;">
          Descri√ß√£o (curta)
          <textarea id="fDesc" placeholder="O que faz? O que a pessoa encontra ao abrir?"></textarea>
        </label>
      </div>

      <div class="modalFooter">
        <button class="btn" id="btnCancelLink">Cancelar</button>
        <button class="btn bad" id="btnDeleteLink" style="display:none;">Excluir</button>
        <button class="btn primary" id="btnSaveLink">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Perfil -->
  <div class="modalBackdrop" id="modalProfile">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>Editar perfil</h3>
        <button class="close" id="closeProfile" aria-label="Fechar">√ó</button>
      </div>

      <div class="modalBody">
        <label>
          Nome
          <input id="pName" />
        </label>

        <label>
          ‚ÄúChips‚Äù (separe por v√≠rgula)
          <input id="pChips" placeholder="Pantanal, Carbono, Sa√∫de, Jogos, Mapas, Extens√£o, Ensino" />
        </label>

        <label style="grid-column:1/-1;">
          Bio (texto curto)
          <textarea id="pBio"></textarea>
        </label>

        <label style="grid-column:1/-1;">
          Foto de perfil (arquivo)
          <input id="pPhoto" type="file" accept="image/*" />
        </label>
      </div>

      <div class="modalFooter">
        <button class="btn" id="btnCancelProfile">Cancelar</button>
        <button class="btn primary" id="btnSaveProfile">Salvar perfil</button>
      </div>
    </div>
  </div>

  <!-- Modal: Import -->
  <div class="modalBackdrop" id="modalImport">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>Importar (JSON)</h3>
        <button class="close" id="closeImport" aria-label="Fechar">√ó</button>
      </div>

      <div class="modalBody" style="grid-template-columns:1fr;">
        <label>
          Cole aqui o JSON exportado
          <textarea id="importBox" placeholder='{"profile":...,"categories":[...],"links":[...]}'></textarea>
        </label>
      </div>

      <div class="modalFooter">
        <button class="btn" id="btnCancelImport">Cancelar</button>
        <button class="btn warn" id="btnDoImport">Importar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <input id="hiddenAvatarPick" type="file" accept="image/*" style="display:none;" />

  <script>
    const KEY = "meuMundoHub_v1";

    // ====== Default Data (ATUALIZADO) ======
    const defaultData = {
      profile: {
        name: "Ernandes Sobreira",
        bio:
`Cacerense ‚Ä¢ Bi√≥logo ‚Ä¢ Pai do Davi e da Sara ‚Ä¢ Marido da B√°rbara
Mestre em Ecologia e Conserva√ß√£o da Biodiversidade ‚Ä¢ Doutor em Ci√™ncia (Radboud University)
Professor visitante da Universidade do Estado de Mato Grosso (UNEMAT)`,
        chips: ["Pantanal","Carbono","Sa√∫de","Jogos","Mapas","Extens√£o","Ensino"],
        photoDataUrl: ""
      },
      categories: [
        { id: "all", name: "Tudo", desc: "Vis√£o geral de todos os links." },
        { id: "clima", name: "Clima & Hidrologia", desc: "Temperatura, precipita√ß√£o, √≠ndices, cotas, conforto t√©rmico." },
        { id: "saude", name: "Sa√∫de", desc: "Clima & sa√∫de, dengue, mortalidade, pain√©is, exames." },
        { id: "jogos", name: "Jogos", desc: "Jogos educativos e experi√™ncias interativas (inclui dengue e carbono)." },
        { id: "mapas", name: "Mapas", desc: "Leaflet, GEE outputs, visualizadores geoespaciais." },
        { id: "ensino", name: "Ensino", desc: "Materiais did√°ticos, bibliometria, plataformas de turma." },
        { id: "extensao", name: "Extens√£o", desc: "Projetos, redes, eventos, participa√ß√£o social." },
        { id: "util", name: "Utilidades", desc: "Ferramentas leves do dia a dia (sorteios, escolhas r√°pidas, etc.)." }
      ],
      links: [],
      ui: { activeCatId: "all", sortAZ: false, search: "" },
      migrations: { movedDengueGames: false }
    };

    const $ = (id) => document.getElementById(id);
    const uid = () => "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16);

    const safeUrl = (u) => {
      const s = String(u || "").trim();
      if (!s) return "";
      if (!/^https?:\/\//i.test(s)) return "https://" + s;
      return s;
    };

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display = "none", 2200);
    }

    function mergeDefaults(obj, def){
      const out = structuredClone(def);
      if(obj && typeof obj === "object"){
        if(obj.profile) out.profile = { ...out.profile, ...obj.profile };
        if(Array.isArray(obj.categories)) out.categories = obj.categories;
        if(Array.isArray(obj.links)) out.links = obj.links;
        if(obj.ui) out.ui = { ...out.ui, ...obj.ui };
        if(obj.migrations) out.migrations = { ...out.migrations, ...obj.migrations };
      }
      return out;
    }

    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return structuredClone(defaultData);
        const parsed = JSON.parse(raw);
        return mergeDefaults(parsed, defaultData);
      }catch(e){
        console.warn(e);
        return structuredClone(defaultData);
      }
    }

    let state = load();

    function save(){
      localStorage.setItem(KEY, JSON.stringify(state));
    }

    function initials(name){
      const parts = String(name).trim().split(/\s+/).filter(Boolean);
      const a = parts[0]?.[0] || "E";
      const b = parts[1]?.[0] || (parts[0]?.[1] || "S");
      return (a + b).toUpperCase();
    }

    // ====== MIGRA√á√ÉO (ATUALIZA Mata Dengue e Chuva & Dengue para Jogos) ======
    function migrateMoveDengueGames(){
      if(state.migrations?.movedDengueGames) return;

      const patterns = [
        "ernandes-sobreira.github.io/mata-dengue",
        "ernandes-sobreira.github.io/chuva-dengue"
      ];

      let changed = 0;
      state.links = (state.links || []).map(l=>{
        const u = (l.url || "").toLowerCase();
        const isTarget = patterns.some(p => u.includes(p));
        if(isTarget && (l.catId === "saude")){
          changed++;
          return { ...l, catId: "jogos" };
        }
        return l;
      });

      state.migrations = state.migrations || {};
      state.migrations.movedDengueGames = true;

      if(changed){
        save();
        toast(`Ajustei ${changed} item(ns) de dengue para a categoria Jogos.`);
      }
    }

    function renderProfile(){
      $("nameEl").textContent = state.profile.name || "Meu Mundo";
      $("bioEl").innerHTML = (state.profile.bio || "").replaceAll("\n","<br/>");

      const chipsBox = $("chips");
      chipsBox.innerHTML = "";
      (state.profile.chips || []).forEach(c=>{
        const span = document.createElement("span");
        span.className = "chip";
        span.textContent = c.trim();
        chipsBox.appendChild(span);
      });

      const img = $("avatarImg");
      const ph = $("avatarPH");
      const durl = state.profile.photoDataUrl || "";
      if(durl){
        img.src = durl;
        img.style.display = "block";
        ph.style.display = "none";
      }else{
        img.style.display = "none";
        ph.style.display = "block";
        ph.textContent = initials(state.profile.name || "ES");
      }
    }

    function countByCategory(){
      const map = {};
      (state.categories || []).forEach(c => map[c.id]=0);
      (state.links || []).forEach(l=>{
        const cid = l.catId || "all";
        map[cid] = (map[cid] || 0) + 1;
      });
      map["all"] = (state.links || []).length;
      return map;
    }

    function renderCategories(){
      const cats = $("cats");
      cats.innerHTML = "";
      const counts = countByCategory();

      (state.categories || []).forEach(cat=>{
        const btn = document.createElement("div");
        btn.className = "catBtn" + (state.ui.activeCatId === cat.id ? " active" : "");
        btn.dataset.id = cat.id;

        const left = document.createElement("div");
        left.style.display="flex";
        left.style.gap="10px";
        left.style.alignItems="center";

        const name = document.createElement("div");
        name.textContent = cat.name;

        left.appendChild(name);

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = String(counts[cat.id] || 0);

        btn.appendChild(left);
        btn.appendChild(badge);

        btn.addEventListener("click", ()=>{
          state.ui.activeCatId = cat.id;
          save();
          renderAll();
        });

        cats.appendChild(btn);
      });
    }

    function renderLinks(){
      const cards = $("cards");
      cards.innerHTML = "";

      const activeCat = state.ui.activeCatId || "all";
      const catObj = (state.categories || []).find(c=>c.id===activeCat) || state.categories?.[0];

      $("sectionTitle").textContent = catObj?.name || "Tudo";
      $("sectionDesc").textContent = catObj?.desc || "Seus links organizados.";

      const q = (state.ui.search || "").trim().toLowerCase();

      let list = (state.links || []).slice();

      if(activeCat !== "all"){
        list = list.filter(l => (l.catId || "") === activeCat);
      }

      if(q){
        list = list.filter(l=>{
          const t = (l.title||"").toLowerCase();
          const d = (l.desc||"").toLowerCase();
          const u = (l.url||"").toLowerCase();
          return t.includes(q) || d.includes(q) || u.includes(q);
        });
      }

      if(state.ui.sortAZ){
        list.sort((a,b)=> (a.title||"").localeCompare((b.title||""), "pt-BR"));
      }

      $("countHint").textContent = `${list.length} link(s)`;
      $("empty").style.display = (list.length===0 ? "block" : "none");

      list.forEach(link=>{
        const cat = (state.categories || []).find(c=>c.id===link.catId);
        const card = document.createElement("div");
        card.className = "card";

        const top = document.createElement("div");
        top.className = "cardTop";

        const left = document.createElement("div");
        left.style.flex="1";

        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = cat?.name || "Sem categoria";

        const h4 = document.createElement("h4");
        h4.textContent = link.title || "(Sem t√≠tulo)";

        const p = document.createElement("p");
        p.textContent = link.desc || "Sem descri√ß√£o.";

        left.appendChild(pill);
        left.appendChild(h4);
        left.appendChild(p);

        const actions = document.createElement("div");
        actions.className = "cardActions";

        const visit = document.createElement("button");
        visit.className = "btn mini primary";
        visit.textContent = "Visitar";
        visit.addEventListener("click", ()=>{
          const url = safeUrl(link.url);
          if(!url) return toast("Esse link est√° sem URL.");
          window.open(url, "_blank", "noopener,noreferrer");
        });

        const edit = document.createElement("button");
        edit.className = "btn mini";
        edit.textContent = "Editar";
        edit.addEventListener("click", ()=> openLinkModal(link.id));

        const copy = document.createElement("button");
        copy.className = "btn mini";
        copy.textContent = "Copiar URL";
        copy.addEventListener("click", async ()=>{
          const url = safeUrl(link.url);
          if(!url) return toast("Sem URL pra copiar.");
          try{
            await navigator.clipboard.writeText(url);
            toast("URL copiada.");
          }catch{
            toast("N√£o consegui copiar (permiss√£o do navegador).");
          }
        });

        actions.appendChild(visit);
        actions.appendChild(edit);
        actions.appendChild(copy);

        top.appendChild(left);
        card.appendChild(top);
        card.appendChild(actions);

        cards.appendChild(card);
      });
    }

    function fillCatSelect(selectEl, keep){
      selectEl.innerHTML = "";
      (state.categories || [])
        .filter(c => c.id !== "all")
        .forEach(c=>{
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.name;
          selectEl.appendChild(opt);
        });

      if(keep && keep !== "all"){
        selectEl.value = keep;
      }else{
        const active = state.ui.activeCatId;
        if(active && active !== "all" && (state.categories || []).some(c=>c.id===active)){
          selectEl.value = active;
        }
      }
    }

    let editingLinkId = null;

    function openLinkModal(id=null){
      editingLinkId = id;
      const modal = $("modalLink");
      const delBtn = $("btnDeleteLink");
      const title = $("modalLinkTitle");

      fillCatSelect($("fCat"));

      if(id){
        const link = (state.links || []).find(l=>l.id===id);
        title.textContent = "Editar link";
        $("fTitle").value = link?.title || "";
        $("fUrl").value = link?.url || "";
        $("fDesc").value = link?.desc || "";
        fillCatSelect($("fCat"), link?.catId);
        delBtn.style.display = "inline-block";
      }else{
        title.textContent = "Adicionar link";
        $("fTitle").value = "";
        $("fUrl").value = "";
        $("fDesc").value = "";
        delBtn.style.display = "none";
      }

      modal.style.display = "flex";
      setTimeout(()=> $("fTitle").focus(), 40);
    }

    function closeLinkModal(){
      $("modalLink").style.display = "none";
      editingLinkId = null;
    }

    function saveLink(){
      const title = $("fTitle").value.trim();
      const url = $("fUrl").value.trim();
      const desc = $("fDesc").value.trim();
      const catId = $("fCat").value;

      if(!title) return toast("Coloque um nome pro link.");
      if(!url) return toast("Coloque a URL do link.");

      const payload = { id: editingLinkId || uid(), title, url: safeUrl(url), desc, catId };

      if(editingLinkId){
        const idx = (state.links || []).findIndex(l=>l.id===editingLinkId);
        if(idx >= 0) state.links[idx] = payload;
      }else{
        state.links.unshift(payload);
      }

      save();
      closeLinkModal();
      renderAll();
      toast("Salvo.");
    }

    function deleteLink(){
      if(!editingLinkId) return;
      const idx = (state.links || []).findIndex(l=>l.id===editingLinkId);
      if(idx < 0) return;
      state.links.splice(idx,1);
      save();
      closeLinkModal();
      renderAll();
      toast("Exclu√≠do.");
    }

    function openProfileModal(){
      $("pName").value = state.profile.name || "";
      $("pBio").value = state.profile.bio || "";
      $("pChips").value = (state.profile.chips || []).join(", ");
      $("pPhoto").value = "";
      $("modalProfile").style.display = "flex";
      setTimeout(()=> $("pName").focus(), 40);
    }
    function closeProfileModal(){ $("modalProfile").style.display = "none"; }

    async function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(String(r.result||""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function saveProfile(){
      const name = $("pName").value.trim() || "Meu Mundo";
      const bio = $("pBio").value.trim();
      const chips = $("pChips").value.split(",").map(s=>s.trim()).filter(Boolean).slice(0, 20);

      const file = $("pPhoto").files?.[0];
      if(file){
        const durl = await fileToDataUrl(file);
        state.profile.photoDataUrl = durl;
      }

      state.profile.name = name;
      state.profile.bio = bio;
      state.profile.chips = chips;

      save();
      closeProfileModal();
      renderAll();
      toast("Perfil salvo.");
    }

    function addCategory(){
      const name = prompt("Nome da nova categoria (ex.: Hidrologia, Bibliometria, PPGCA, etc.):");
      if(!name) return;

      const id = name.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9]+/g,"-")
        .replace(/(^-|-$)/g,"")
        .slice(0, 32) || uid();

      if((state.categories || []).some(c=>c.id===id)){
        toast("J√° existe uma categoria com esse ID. Tente outro nome.");
        return;
      }

      const desc = prompt("Descri√ß√£o curta da categoria (opcional):") || "";
      state.categories.push({ id, name: name.trim(), desc: desc.trim() });
      save();
      renderAll();
      toast("Categoria criada.");
    }

    function openAllInCategory(){
      const active = state.ui.activeCatId || "all";
      const q = (state.ui.search || "").trim().toLowerCase();

      let list = (state.links || []).slice();
      if(active !== "all") list = list.filter(l => l.catId === active);
      if(q){
        list = list.filter(l=>{
          const t=(l.title||"").toLowerCase();
          const d=(l.desc||"").toLowerCase();
          const u=(l.url||"").toLowerCase();
          return t.includes(q)||d.includes(q)||u.includes(q);
        });
      }
      if(list.length===0) return toast("Nada pra abrir nessa vis√£o.");
      if(list.length>12){
        const ok = confirm(`Voc√™ est√° prestes a abrir ${list.length} links. Continuar?`);
        if(!ok) return;
      }
      list.forEach(l=>{
        const url = safeUrl(l.url);
        if(url) window.open(url, "_blank", "noopener,noreferrer");
      });
      toast("Abrindo links‚Ä¶");
    }

    function toggleSort(){
      state.ui.sortAZ = !state.ui.sortAZ;
      save();
      renderAll();
      toast(state.ui.sortAZ ? "Ordenado A‚ÜíZ" : "Ordem manual");
    }

    function exportJson(){
      const payload = JSON.stringify(state, null, 2);
      const blob = new Blob([payload], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "meu-mundo-hub.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exportado.");
    }

    function openImportModal(){
      $("importBox").value = "";
      $("modalImport").style.display = "flex";
      setTimeout(()=> $("importBox").focus(), 40);
    }
    function closeImportModal(){ $("modalImport").style.display = "none"; }

    function doImport(){
      const raw = $("importBox").value.trim();
      if(!raw) return toast("Cole o JSON primeiro.");
      try{
        const parsed = JSON.parse(raw);
        state = mergeDefaults(parsed, defaultData);
        save();
        closeImportModal();
        renderAll();
        toast("Importado.");
      }catch(e){
        toast("JSON inv√°lido.");
      }
    }

    function resetAll(){
      const ok = confirm("Isso apaga seus links e categorias deste navegador. Quer mesmo resetar?");
      if(!ok) return;
      state = structuredClone(defaultData);
      save();
      renderAll();
      toast("Resetado.");
    }

    function renderAll(){
      renderProfile();
      renderCategories();
      renderLinks();
      $("search").value = state.ui.search || "";
    }

    // Avatar click -> quick photo
    $("avatarBox").addEventListener("click", ()=> $("hiddenAvatarPick").click());
    $("hiddenAvatarPick").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      state.profile.photoDataUrl = await fileToDataUrl(f);
      save();
      renderAll();
      toast("Foto atualizada.");
      e.target.value = "";
    });

    // Events
    $("btnAdd").addEventListener("click", ()=> openLinkModal(null));
    $("btnEditProfile").addEventListener("click", openProfileModal);
    $("btnExport").addEventListener("click", exportJson);
    $("btnImport").addEventListener("click", openImportModal);
    $("btnOpenAll").addEventListener("click", openAllInCategory);
    $("btnReset").addEventListener("click", resetAll);
    $("btnNewCategory").addEventListener("click", addCategory);
    $("btnSort").addEventListener("click", toggleSort);

    $("closeLink").addEventListener("click", closeLinkModal);
    $("btnCancelLink").addEventListener("click", closeLinkModal);
    $("btnSaveLink").addEventListener("click", saveLink);
    $("btnDeleteLink").addEventListener("click", deleteLink);

    $("closeProfile").addEventListener("click", closeProfileModal);
    $("btnCancelProfile").addEventListener("click", closeProfileModal);
    $("btnSaveProfile").addEventListener("click", saveProfile);

    $("closeImport").addEventListener("click", closeImportModal);
    $("btnCancelImport").addEventListener("click", closeImportModal);
    $("btnDoImport").addEventListener("click", doImport);

    ["modalLink","modalProfile","modalImport"].forEach(id=>{
      $(id).addEventListener("click", (e)=>{
        if(e.target.id===id) $(id).style.display="none";
      });
    });

    $("search").addEventListener("input", (e)=>{
      state.ui.search = e.target.value || "";
      save();
      renderAll();
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        $("modalLink").style.display="none";
        $("modalProfile").style.display="none";
        $("modalImport").style.display="none";
      }
    });

    // ====== INIT ======
    migrateMoveDengueGames();
    renderAll();
  </script>
</body>
</html>
